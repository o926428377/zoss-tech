<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>LIFF Send Message</title>   
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  </head>
  <body class="p-4" style="height:100vh;background-image: url('https://i.imgur.com/F0nAnwj.png');background-size: 100% auto;background-repeat: repeat-y;">
  <div id="loading" class="w-100 position-absolute bg-dark" style="z-index: 999;left: 0px;top: 0px;height: 105vh;">
    <div class="position-absolute top-50 start-50 translate-middle" style="text-align: center;"\>
    <div class="spinner-border text-primary" id="spinner" role="status" style="width: 5rem;height: 5rem;">
    <span class="sr-only"></span>
    </div>
    <div id="mask" class="fs-1 text-white">登入中...</div>
    </div>
  </div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
    function getToken(liffId) {
        return new Promise(function(resolve,reject){
            liff.init({
                        liffId: liffId,
                        withLoginOnExternalBrowser: true
                    }).then(function (data) {
                liff.getProfile().then(function (profile) {
                var params = {};
                params['userId'] = profile.userId;
                const accessToken =  liff.getAccessToken();
                if (!accessToken) {
                    params['accessToken'] = 'Error';
                }
                params['accessToken'] = accessToken;
                //console.log(params);
                resolve(params);
                }).catch(function (error) {
                window.alert("Error getting profile: " + error);
                reject(params);
                });
            // }
            });
        });
    };

    var params = new URL(document.location.toString()).searchParams;
    if (params.has("liffRedirectUri")) {
    params = new URL(decodeURIComponent(params.get("liffRedirectUri"))).searchParams;
    }
    if (!params.has("liff")) {
    Swal.fire({
            title: '系統錯誤',
            text: "無效參數",
            icon: "error"
    });
    pause
    }

    var liffId = params.get("liff");
    var msg = params.get("msg");

    function sys_error() {
        Swal.fire({
                title: '系統錯誤',
                text: "請重新整理",
                icon: "error",
                timer: 5000
        }).then(function(){
            liff.closeWindow();
        });
    }

    window.onload = async function (e) {
        // load_config();
        getToken(liffId).then(function(params){
            document.getElementById("loading").style.display = "none";
            liff.sendMessages([
                {
                  type: "text",
                  text: msg,
                },
            ])
            .then(() => {
              liff.closeWindow();
            });
          
        }).catch(function (error) {
            sys_error();
        });
      };

</script>
  </body>
</html>
