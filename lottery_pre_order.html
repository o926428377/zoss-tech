<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>威力彩購買登記</title>   
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        /* 網格佈局：改為 5 個一列 */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 修改：從 10 改為 5 */
            gap: 10px; /* 修改：增加間距讓按鈕分開一點 */
            padding: 10px;
        }

        /* 金屬質感按鈕樣式 */
        .btn-metal {
            width: 100%;
            padding: 5px 0; /* 修改：增加高度，方便點選 */
            font-size: 20px; /* 修改：字體放大 */
            font-weight: bold;
            color: #333;
            /* 金屬光澤漸層 */
            background: linear-gradient(to bottom, #f7f7f7 0%, #dcdcdc 50%, #bababa 51%, #cfcfcf 100%);
            border: 1px solid #888;
            border-radius: 8px; /* 修改：圓角稍微加大 */
            /* 外部陰影增加立體感，內部高光 */
            box-shadow: 0 2px 5px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.7);
            /* 文字刻印效果 */
            text-shadow: 0 1px 0 rgba(255,255,255,0.8);
            transition: all 0.1s;
        }

        /* 按鈕懸停效果 */
        .btn-metal:hover {
            background: linear-gradient(to bottom, #ffffff 0%, #eeeeee 50%, #cccccc 51%, #e0e0e0 100%);
            color: #000;
        }

        /* 按鈕點擊(按下)效果 */
        .btn-metal:active {
            background: linear-gradient(to bottom, #aaaaaa 0%, #cccccc 100%);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
            border-color: #555;
            color: #fff;
            text-shadow: 0 -1px 0 rgba(0,0,0,0.5);
            transform: translateY(2px);
        }
    </style>
  </head>
  <body class="p-4" style="height:100vh;background-image: url('https://i.imgur.com/F0nAnwj.png');background-size: 100% auto;background-repeat: repeat-y;">
  <div id="loading" class="w-100 position-absolute bg-dark" style="z-index: 999;left: 0px;top: 0px;height: 105vh;">
    <div class="position-absolute top-50 start-50 translate-middle" style="text-align: center;"\>
    <div class="spinner-border text-primary" id="spinner" role="status" style="width: 5rem;height: 5rem;">
    <span class="sr-only"></span>
    </div>
    <div id="mask" class="fs-1 text-white">登入中...</div>
    </div>
  </div>

  <div style="height: 95%;" class="py-3">
    <div class="h-100 col d-flex align-items-center justify-content-center">
    <div id="order" class="card text-dark bg-light mb-3" style="max-height: 100%;width: 100%;opacity: 0.95;overflow: auto;">
        <!-- 按鈕將會生成在這裡 -->
    </div>
    </div>
  </div>
  <div style="width:100%;" class="justify-content-center">
    <img id="ft_img" src="https://i.imgur.com/YsAKWQX.png" style="width:100%"></img>
  </div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
    function getToken(liffId) {
        return new Promise(function(resolve,reject){
            liff.init({
                        liffId: liffId,
                        withLoginOnExternalBrowser: true
                    }).then(function (data) {
                liff.getProfile().then(function (profile) {
                var params = {};
                params['userId'] = profile.userId;
                const accessToken =  liff.getAccessToken();
                if (!accessToken) {
                    params['accessToken'] = 'Error';
                }
                params['accessToken'] = accessToken;
                resolve(params);
                }).catch(function (error) {
                window.alert("Error getting profile: " + error);
                reject(params);
                });
            });
        });
    };

    function sendPost(url, _params) {
        // ... (保持原有的 form submit fallback 邏輯) ...
        return new Promise(function(resolve,reject){
            fetch(`${url}`, {
            method: "POST",
            redirect: "follow", 
            headers: {
                "Content-Type": "text/plain",
            },
            body: JSON.stringify(_params)
            })
            .then(response => response.text())
            .then(context => {
            var data = JSON.parse(context);
            resolve(data);
            });
        })
    };

    var params = new URL(document.location.toString()).searchParams;
    if (params.has("liffRedirectUri")) {
    params = new URL(decodeURIComponent(params.get("liffRedirectUri"))).searchParams;
    }
    if (!params.has("liff") || (!params.has("sid")&&!params.has("app"))) {
    Swal.fire({
            title: '系統錯誤',
            text: "無效參數",
            icon: "error"
    });
    }

    var liffId = params.get("liff");
    var url;
    if (params.get("sid")) {
      url = `https://script.google.com/macros/s/${params.get("sid")}/exec`;
    } else if (params.get("app")) {
      url = `https://${params.get("app")}.a.run.app`;
    }

    function sys_error() {
        Swal.fire({
                title: '系統錯誤',
                text: "請重新整理",
                icon: "error",
                timer: 5000
        }).then(function(){
            liff.closeWindow();
        });
    }

    // 新增：確認對話方塊函式
    function confirm_order(val) {
        var titleText = "";
        var btnText = "";
        var btnColor = "";

        if(val === 0) {
            titleText = "確定要取消登記嗎？";
            btnText = "是，取消登記";
            btnColor = "#dc3545"; // 紅色
        } else {
            titleText = `您選擇了 <span style="color:red; font-size: 1.2em;">${val}</span> 張`;
            btnText = "確認送出";
            btnColor = "#3085d6"; // 藍色
        }

        Swal.fire({
            title: '確認數量',
            html: titleText, // 使用 html 屬性以支援上面的 span 標籤
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: btnColor,
            cancelButtonColor: '#6c757d',
            confirmButtonText: btnText,
            cancelButtonText: '再想想',
            reverseButtons: true // 讓確認按鈕在右邊
        }).then((result) => {
            if (result.isConfirmed) {
                // 使用者點選確認後，才執行送出流程
                submit_process(val);
            }
        });
    }

    // 實際執行送出的函式 (原本的 submit_process)
    function submit_process(val) {
        getToken(liffId).then(function(params){
            
            document.getElementById("mask").textContent = val === 0 ? "取消中..." : "登記中...";
            document.getElementById("loading").style.display = "inline";
            
            var qty = val;

            sendPost(`${url}?role=lottery_pre_order`, {"qty": qty, ...params}).then(function(response){
                if (typeof response.msg !== "undefined") {
                    sys_error();
                } else {
                    if (response.result==="NotMember") {
                        Swal.fire({
                            title: "系統錯誤",
                            text: "無法登記，您尚未完成福利社LINE@綁定。",
                            icon: "error",
                            showDenyButton: false,
                            showCancelButton: false,
                            confirmButtonText: "關閉"
                        }).then(function() {
                            liff.closeWindow();
                        });
                    } else if (response.result==="Expired") {
                        Swal.fire({
                            title: "系統錯誤",
                            text: "無法登記，以超過登記截止日。",
                            icon: "error",
                            showDenyButton: false,
                            showCancelButton: false,
                            confirmButtonText: "關閉"
                        }).then(function() {
                            liff.closeWindow();
                        });
                    } else if (response.result==="QtyPrize") {
                        Swal.fire({
                            title: "系統錯誤",
                            text: "您輸入的數量不正確，請重新操作。",
                            icon: "error",
                            showDenyButton: false,
                            showCancelButton: false,
                            confirmButtonText: "關閉"
                        }).then(function() {
                            liff.closeWindow();
                        });
                    } else if (response.result==="OK") {
                        liff.sendMessages([
                            response.flex_msg
                        ])
                        .then(() => {
                          Swal.fire({
                              title: val === 0 ? "取消成功" : "登記完成", 
                              icon: "success",
                              showDenyButton: false,
                              showCancelButton: false,
                              timer: 5000,
                              confirmButtonText: "關閉"
                          }).then(function() {
                              liff.closeWindow();
                          });
                        })
                        .catch((err) => {
                            Swal.fire({
                                  title: '系統錯誤',
                                text: JSON.stringify(response.msg),
                                  icon: "error"
                          }).then(function(){
                              liff.closeWindow();
                          })
                        });
                    } else {
                        sys_error();
                    }
                }
            });
        }).catch(function (error) {
            sys_error();
        });
    }

    // 生成按鈕介面
    function pre_order() {
        var html = '<h5 class="text-center my-3 fw-bold" style="color: #444; text-shadow: 0 1px 0 #fff;">請登記「欲購買的威力彩張數」</h5>';
        
        html += '<div class="grid-container">';
        
        // 產生 1 ~ 50 的金屬質感按鈕
        for (var i = 1; i <= 50; i++) {
            // 修改：onclick 改為呼叫 confirm_order
            html += `<button type="button" class="btn btn-metal" onclick="confirm_order(${i})">${i}</button>`;
        }
        html += '</div>';

        // 取消登記按鈕
        html += `<div class="p-2 border-top mt-2">
            <!-- 修改：onclick 改為呼叫 confirm_order(0) -->
            <button type="button" class="btn btn-danger w-100 shadow fw-bold p-3 fs-5" onclick="confirm_order(0)">取消登記</button>
        </div>`;

        document.getElementById("order").innerHTML = html;
    }

    function changeImage(_name, src) {
      const imageElement = document.getElementById(_name);
      if (_name === "bg_img") {
        imageElement.style.backgroundImage = `url('${src}')`;
      } else if (imageElement) {
        imageElement.src = src;
      } else if (_name === "body") {
        const body = document.body;
        body.style.backgroundImage = `url('${src}')`;
      }
    }

    window.onload = async function (e) {
        getToken(liffId).then(function(params){
            document.getElementById("loading").style.display = "none";
            pre_order();
            return; 

            // 原有的權限檢查
            sendPost(`${url}?role=permission_check`, params).then(function(response){
                if (typeof response.msg !== "undefined") {
                    sys_error();
                } else {
                  if (response.result==="NotMember") {
                    Swal.fire({
                        title: "系統錯誤",
                        text: "無法登記，您尚未完成福利社LINE@綁定。",
                        icon: "error",
                        showDenyButton: false,
                        showCancelButton: false,
                        confirmButtonText: "關閉"
                    }).then(function() {
                        liff.closeWindow();
                    });
                  } else if (response.result==="OK") {
                      document.getElementById("loading").style.display = "none";
                      changeImage("ft_img", response.shared_ft_img);
                      changeImage("body", response.shared_bg_img);
                      pre_order();
                  }
                }
            });
        }).catch(function (error) {
            sys_error();
        });
      };

</script>
  </body>
</html>
