<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>HAPPYHAIR / GENIC 抽獎活動</title>
    <style>
      #container6 {
      margin: auto;
        background-size: cover;
        display: table-cell;
        vertical-align: middle;
        
      }
      #child {
      line-height: 3em;
      display: table-cell;
      vertical-align: middle;
      height:100vh;   
      -moz-box-sizing: border-box;    
      }
      .panel-body{
          background: rgba(255, 255, 255, 0.85)!important;
      }
      @charset "UTF-8";
      *, *::before, *::after {
        box-sizing: border-box;
      }
      
      .main-block {
        margin-right: 25vw;
        width: 100vw;
        text-align: center;
      }
      
      @media screen and (max-width: 768px) {
        .main-block {
          margin-right: 0;
          width: calc(100vw - 16px);
        }
      }
      
      /* =========================================
        老虎機主體 (The Slot Machine) - 華麗核心
        ========================================= */
      :root {
        /* [基礎轉速]：數字越大，轉得越慢 */
        /* 原本約 0.03s，現在改 0.06s 讓它穩重一點 */
        --spin-unit: 0.12s; 

        /* [煞車時間]：中獎時停下來花的時間 */
        /* 數字越大，緩衝滑行越久 */
        --stop-time: 3s; 
      }
      .god {
        margin: 0 auto 1rem auto;
        padding: 3rem 1.5rem;
        position: relative;
        
        /* 機身質感：深灰金屬 + 金色邊框 */
        background: linear-gradient(180deg, #2b2b2b 0%, #1a1a1a 40%, #000000 100%);
        border: 4px solid #b8860b; /* 暗金色基底 */
        border-radius: 15px;
        
        /* 多重陰影打造立體感與發光感 */
        box-shadow: 
          0 0 0 2px #000,              /* 黑色分隔線 */
          0 0 0 6px #d4af37,           /* 亮金外框 */
          0 0 0 8px #5c4308,           /* 深金外緣 */
          0 20px 50px rgba(0,0,0,0.8), /* 底部懸浮深影 */
          inset 0 0 60px rgba(0,0,0,0.9); /* 內部深邃感 */
          
        display: inline-block;
        max-width: 100%;
      }

      /* 裝飾：頂部玻璃反光 */
      .god::before {
        content: "";
        position: absolute;
        top: 0; left: 6px; right: 6px;
        height: 35%;
        background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0) 100%);
        border-radius: 10px 10px 40% 40%;
        pointer-events: none;
        z-index: 10;
      }

      /* 裝飾：中獎線 (Focus Line) - 視覺焦點
      .god::after {
        content: "";
        position: absolute;
        top: 50%;
        left: -5%;
        right: -5%;
        height: 75px; 
        transform: translateY(-50%);
        border-top: 2px solid rgba(255, 215, 0, 0.8);
        border-bottom: 2px solid rgba(255, 215, 0, 0.8);
        background: linear-gradient(90deg, 
          transparent 0%, 
          rgba(255, 215, 0, 0.1) 20%, 
          rgba(255, 215, 0, 0.1) 80%, 
          transparent 100%);
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        pointer-events: none;
        z-index: 20;
      }
      */

      .god h1 {
        margin: 0;
        display: flex;
        justify-content: center;
        gap: 8px; /* 滾輪間距 */
      }

      /* =========================================
        滾輪設定 (Reels)
        ========================================= */
      .god span.wrap {
        display: block;
        display: inline-grid;
        max-height: 100px; /* 視窗高度 */
        overflow: hidden;
        
        /* 滾輪質感：白色底 + 內陰影模擬圓柱彎曲 */
        background-color: #fcfcfc; 
        color: #333;
        border-radius: 4px;
        border: 1px solid #444;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.4); 
        position: relative;
      }

      /* 滾輪內的文字 */
      .god .wrap > span {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 73px; /* 必須固定高度 */
        width: 100%;
        
        font-size: 1.8rem; /* 字体加大 */
        font-weight: 900;
        font-family: "Arial Black", "Impact", sans-serif;
        color: #222;
        letter-spacing: 1px;
        
        will-change: transform; /* 效能優化關鍵 */
        animation-iteration-count: infinite;
        animation-timing-function: linear;
      }

      /* 欄位寬度 RWD */
      .god .wrap.no1 { width: 15vw; min-width: 110px; }
      .god .wrap.no2 { width: 42vw; min-width: 220px; }
      .god .wrap.no3 { width: 25vw; min-width: 140px; }

      @media screen and (max-width: 768px) {
        .god { padding: 2rem 0.5rem; border-width: 2px; box-shadow: 0 0 0 1px #000, 0 0 0 3px #d4af37; }
        .god .wrap > span { font-size: 1.3rem; }
        .god .wrap.no1 { width: 20vw; min-width: auto; }
        .god .wrap.no2 { width: 45vw; min-width: auto; }
        .god .wrap.no3 { width: 25vw; min-width: auto; }
      }

      /* =========================================
        按鈕與結果顯示 (Buttons & UI)
        ========================================= */
      #shoot {
          background: linear-gradient(145deg, #d4af37, #b8860b); /* 金色漸層 */
          border: none;
          color: #fff;
          font-weight: bold;
          text-shadow: 0 1px 2px rgba(0,0,0,0.5);
          box-shadow: 0 5px 15px rgba(0,0,0,0.3);
          transition: all 0.2s;
      }
      #shoot:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: 0 8px 20px rgba(212, 175, 55, 0.4);
      }
      #shoot:disabled {
          background: #555;
          color: #888;
          cursor: not-allowed;
      }

      #prize_name {
          background: linear-gradient(135deg, #28a745, #1e7e34);
          border: 2px solid #fff;
          box-shadow: 0 0 20px rgba(40, 167, 69, 0.5);
          font-size: 2rem;
          padding: 0.5rem 2rem;
          border-radius: 50px;
          font-weight: 800;
      }

      #drawn_list {
          background: rgba(255,255,255,0.9);
          border-radius: 10px;
          padding: 10px;
          box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      }

      /* =========================================
        動畫關鍵影格 (Keyframes - Optimized)
        全數改為 transform: translateY 以達 60FPS
        ========================================= */

      /* 通用動畫邏輯：移動距離 = -73px * N */

      @keyframes spin-1 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 1)); } }
      .god .wrap > .span-1 { animation-name: spin-1; animation-duration: calc(var(--spin-unit) * 1); }

      @keyframes spin-2 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 2)); } }
      .god .wrap > .span-2 { animation-name: spin-2; animation-duration: calc(var(--spin-unit) * 2); }

      @keyframes spin-3 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 3)); } }
      .god .wrap > .span-3 { animation-name: spin-3; animation-duration: calc(var(--spin-unit) * 3); }

      @keyframes spin-4 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 4)); } }
      .god .wrap > .span-4 { animation-name: spin-4; animation-duration: calc(var(--spin-unit) * 4); }

      @keyframes spin-5 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 5)); } }
      .god .wrap > .span-5 { animation-name: spin-5; animation-duration: calc(var(--spin-unit) * 5); }

      @keyframes spin-6 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 6)); } }
      .god .wrap > .span-6 { animation-name: spin-6; animation-duration: calc(var(--spin-unit) * 6); }

      @keyframes spin-7 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 7)); } }
      .god .wrap > .span-7 { animation-name: spin-7; animation-duration: calc(var(--spin-unit) * 7); }

      @keyframes spin-8 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 8)); } }
      .god .wrap > .span-8 { animation-name: spin-8; animation-duration: calc(var(--spin-unit) * 8); }

      @keyframes spin-9 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 9)); } }
      .god .wrap > .span-9 { animation-name: spin-9; animation-duration: calc(var(--spin-unit) * 9); }

      /* *** 重要：結果停止狀態 (Stop State) *** */
      /* 這是你的 JS 程式碼用來「停下」的 class (span-10) */
      @keyframes spin-10 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 10)); } }
      .god .wrap > .span-10 { animation-name: spin-10; animation-duration: calc(var(--spin-unit) * 10); }
      /* .god .wrap > .span-10 { 
          animation-name: spin-10; 
          animation-duration: var(--stop-time); 
          animation-timing-function: cubic-bezier(0.23, 1, 0.32, 1); 
      } */

      /* --- Spin 11 to 20 --- */
      @keyframes spin-11 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 11)); } }
      .god .wrap > .span-11 { animation-name: spin-11; animation-duration: calc(var(--spin-unit) * 11); }

      @keyframes spin-12 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 12)); } }
      .god .wrap > .span-12 { animation-name: spin-12; animation-duration: calc(var(--spin-unit) * 12); }

      @keyframes spin-13 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 13)); } }
      .god .wrap > .span-13 { animation-name: spin-13; animation-duration: calc(var(--spin-unit) * 13); }

      @keyframes spin-14 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 14)); } }
      .god .wrap > .span-14 { animation-name: spin-14; animation-duration: calc(var(--spin-unit) * 14); }

      @keyframes spin-15 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 15)); } }
      .god .wrap > .span-15 { animation-name: spin-15; animation-duration: calc(var(--spin-unit) * 15); }

      @keyframes spin-16 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 16)); } }
      .god .wrap > .span-16 { animation-name: spin-16; animation-duration: calc(var(--spin-unit) * 16); }

      @keyframes spin-17 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 17)); } }
      .god .wrap > .span-17 { animation-name: spin-17; animation-duration: calc(var(--spin-unit) * 17); }

      @keyframes spin-18 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 18)); } }
      .god .wrap > .span-18 { animation-name: spin-18; animation-duration: calc(var(--spin-unit) * 18); }

      @keyframes spin-19 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 19)); } }
      .god .wrap > .span-19 { animation-name: spin-19; animation-duration: calc(var(--spin-unit) * 19); }

      @keyframes spin-20 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 20)); } }
      .god .wrap > .span-20 { animation-name: spin-20; animation-duration: calc(var(--spin-unit) * 20); }

      /* --- Spin 21 to 30 --- */
      @keyframes spin-21 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 21)); } }
      .god .wrap > .span-21 { animation-name: spin-21; animation-duration: calc(var(--spin-unit) * 21); }

      @keyframes spin-22 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 22)); } }
      .god .wrap > .span-22 { animation-name: spin-22; animation-duration: calc(var(--spin-unit) * 22); }

      @keyframes spin-23 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 23)); } }
      .god .wrap > .span-23 { animation-name: spin-23; animation-duration: calc(var(--spin-unit) * 23); }

      @keyframes spin-24 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 24)); } }
      .god .wrap > .span-24 { animation-name: spin-24; animation-duration: calc(var(--spin-unit) * 24); }

      @keyframes spin-25 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 25)); } }
      .god .wrap > .span-25 { animation-name: spin-25; animation-duration: calc(var(--spin-unit) * 25); }

      @keyframes spin-26 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 26)); } }
      .god .wrap > .span-26 { animation-name: spin-26; animation-duration: calc(var(--spin-unit) * 26); }

      @keyframes spin-27 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 27)); } }
      .god .wrap > .span-27 { animation-name: spin-27; animation-duration: calc(var(--spin-unit) * 27); }

      @keyframes spin-28 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 28)); } }
      .god .wrap > .span-28 { animation-name: spin-28; animation-duration: calc(var(--spin-unit) * 28); }

      @keyframes spin-29 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 29)); } }
      .god .wrap > .span-29 { animation-name: spin-29; animation-duration: calc(var(--spin-unit) * 29); }

      @keyframes spin-30 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 30)); } }
      .god .wrap > .span-30 { animation-name: spin-30; animation-duration: calc(var(--spin-unit) * 30); }

      /* --- Spin 31 to 40 --- */
      @keyframes spin-31 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 31)); } }
      .god .wrap > .span-31 { animation-name: spin-31; animation-duration: calc(var(--spin-unit) * 31); }

      @keyframes spin-32 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 32)); } }
      .god .wrap > .span-32 { animation-name: spin-32; animation-duration: calc(var(--spin-unit) * 32); }

      @keyframes spin-33 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 33)); } }
      .god .wrap > .span-33 { animation-name: spin-33; animation-duration: calc(var(--spin-unit) * 33); }

      @keyframes spin-34 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 34)); } }
      .god .wrap > .span-34 { animation-name: spin-34; animation-duration: calc(var(--spin-unit) * 34); }

      @keyframes spin-35 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 35)); } }
      .god .wrap > .span-35 { animation-name: spin-35; animation-duration: calc(var(--spin-unit) * 35); }

      @keyframes spin-36 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 36)); } }
      .god .wrap > .span-36 { animation-name: spin-36; animation-duration: calc(var(--spin-unit) * 36); }

      @keyframes spin-37 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 37)); } }
      .god .wrap > .span-37 { animation-name: spin-37; animation-duration: calc(var(--spin-unit) * 37); }

      @keyframes spin-38 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 38)); } }
      .god .wrap > .span-38 { animation-name: spin-38; animation-duration: calc(var(--spin-unit) * 38); }

      @keyframes spin-39 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 39)); } }
      .god .wrap > .span-39 { animation-name: spin-39; animation-duration: calc(var(--spin-unit) * 39); }

      @keyframes spin-40 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 40)); } }
      .god .wrap > .span-40 { animation-name: spin-40; animation-duration: calc(var(--spin-unit) * 40); }

      /* --- Spin 41 to 50 --- */
      @keyframes spin-41 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 41)); } }
      .god .wrap > .span-41 { animation-name: spin-41; animation-duration: calc(var(--spin-unit) * 41); }

      @keyframes spin-42 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 42)); } }
      .god .wrap > .span-42 { animation-name: spin-42; animation-duration: calc(var(--spin-unit) * 42); }

      @keyframes spin-43 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 43)); } }
      .god .wrap > .span-43 { animation-name: spin-43; animation-duration: calc(var(--spin-unit) * 43); }

      @keyframes spin-44 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 44)); } }
      .god .wrap > .span-44 { animation-name: spin-44; animation-duration: calc(var(--spin-unit) * 44); }

      @keyframes spin-45 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 45)); } }
      .god .wrap > .span-45 { animation-name: spin-45; animation-duration: calc(var(--spin-unit) * 45); }

      @keyframes spin-46 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 46)); } }
      .god .wrap > .span-46 { animation-name: spin-46; animation-duration: calc(var(--spin-unit) * 46); }

      @keyframes spin-47 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 47)); } }
      .god .wrap > .span-47 { animation-name: spin-47; animation-duration: calc(var(--spin-unit) * 47); }

      @keyframes spin-48 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 48)); } }
      .god .wrap > .span-48 { animation-name: spin-48; animation-duration: calc(var(--spin-unit) * 48); }

      @keyframes spin-49 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 49)); } }
      .god .wrap > .span-49 { animation-name: spin-49; animation-duration: calc(var(--spin-unit) * 49); }

      @keyframes spin-50 { from { transform: translateY(0); } to { transform: translateY(calc(-73px * 50)); } }
      .god .wrap > .span-50 { animation-name: spin-50; animation-duration: calc(var(--spin-unit) * 50); }

      .btns {
        display: flex;
        margin-bottom: 3rem;
      }
      
      .vegetarian {
        padding-right: 2px;
        color: #689F38;
      }
      
      .btn-start {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        z-index: 1;
        margin-top: 5vh;
        margin-bottom: 2vh;
        margin-left: 2rem;
        padding: 1rem 2rem;
        width: 100%;
        border: 1px solid rgba(41, 44, 55, 0.27);
        text-decoration: none;
        color: rgba(41, 44, 55, 0.54);
      }
      .btn-start::after {
        content: "轉動命運輪盤";
        line-height: 1;
      }
      .btn-start:hover {
        color: #CD0505;
      }
      .btn-start.not-allow {
        pointer-events: none;
      }
      .btn-start.not-allow::after {
        font-family: "FontAwesome";
        content: "\f110";
        -webkit-animation: fa-spin 2s infinite linear;
                animation: fa-spin 2s infinite linear;
      }
      .btn-start.not-allow:hover {
        color: #CCC;
      }
      
      @media screen and (max-width: 768px) {
        .btn-start {
          background-color: rgb(255, 255, 255);
        }
      }
      .btn-start .line, .btn-start.not-allow .line {
        position: absolute;
        background: #CD0505;
        -webkit-transform: scale(0);
                transform: scale(0);
        transition: -webkit-transform 0.1s ease;
        transition: transform 0.1s ease;
        transition: transform 0.1s ease, -webkit-transform 0.1s ease;
      }
      .btn-start .line.-h, .btn-start.not-allow .line.-h {
        width: 100%;
        height: 2px;
      }
      .btn-start .line.-v, .btn-start.not-allow .line.-v {
        width: 2px;
        height: 100%;
      }
      .btn-start .line.top, .btn-start.not-allow .line.top {
        top: -2px;
        left: 0;
        -webkit-transform-origin: left;
                transform-origin: left;
      }
      .btn-start .line.right, .btn-start.not-allow .line.right {
        transform: translateY(0);
        right: -2px;
        -webkit-transform-origin: top;
                transform-origin: top;
      }
      .btn-start .line.bottom, .btn-start.not-allow .line.bottom {
        bottom: -2px;
        right: 0;
        -webkit-transform-origin: right;
                transform-origin: right;
      }
      .btn-start .line.left, .btn-start.not-allow .line.left {
        bottom: 0;
        left: -2px;
        -webkit-transform-origin: bottom;
                transform-origin: bottom;
      }
      
      .btn-start.not-allow {
        border-color: transparent;
      }
      .btn-start.not-allow, .btn-start.not-allow:hover {
        color: #CD0505;
      }
      .btn-start.not-allow .line {
        background: transparent;
      }
      
      .btn-start .line.top, .btn-start.not-allow .line.top {
        transition-delay: 0.3s;
      }
      .btn-start .line.right, .btn-start.not-allow .line.right {
        transition-delay: 0.2s;
      }
      .btn-start .line.bottom, .btn-start.not-allow .line.bottom {
        transition-delay: 0.1s;
      }
      .btn-start .line.left, .btn-start.not-allow .line.left {
        transition-delay: 0;
      }
      
      .btn-start:hover .line, .btn-start.not-allow:hover .line {
        -webkit-transform: scale(1);
                transform: scale(1);
      }
      .btn-start:hover .line.top, .btn-start.not-allow:hover .line.top {
        transition-delay: 0s;
      }
      .btn-start:hover .line.right, .btn-start.not-allow:hover .line.right {
        transition-delay: 0.1s;
      }
      .btn-start:hover .line.bottom, .btn-start.not-allow:hover .line.bottom {
        transition-delay: 0.2s;
      }
      .btn-start:hover .line.left, .btn-start.not-allow:hover .line.left {
        transition-delay: 0.3s;
      }
      
      .toggle {
        position: relative;
        display: inline-block;
        width: 100px;
        height: 54px;
      }
      .toggle input {
        display: none;
      }
      
      .button {
        position: absolute;
        cursor: pointer;
        transform: translateY(0);
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        box-shadow: 0 2px 1px 0 rgba(255, 255, 255, 0.5), inset 0 1px 3px 0 rgba(0, 0, 0, 0.2);
      }
      .button:before {
        position: absolute;
        content: "";
        height: 46px;
        width: 46px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        box-shadow: 0 0 4px 0 rgba(0, 0, 0, 0.2), 0px 4px 23px 0 rgba(0, 0, 0, 0.08), -2px 4px 4px 0 rgba(0, 0, 0, 0.1);
      }
      
      input:checked + .button {
        background-color: #8BC34A;
      }
      input:focus + .button {
        box-shadow: 0 0 1px #2196F3;
      }
      input:checked + .button:before, input:checked + .button:after {
        -webkit-transform: translateX(46px);
                transform: translateX(46px);
      }
      input:checked + .button:after {
        color: #689F38;
      }
      
      .button.round {
        border-radius: 34px;
      }
      .button.round:before {
        border-radius: 50%;
      }
      .button.round:after {
        font-family: "FontAwesome";
        content: "\f18c";
        position: absolute;
        left: 4px;
        bottom: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 46px;
        width: 46px;
        font-size: 1.5rem;
        color: #ccc;
        transition: 0.4s;
      }
      
      .map {
        width: 100%;
      }
      .map iframe {
        width: 100%;
        height: 22.5vw;
        transition: all 0.5s ease;
      }
      .map .hidden {
        visibility: hidden;
        opacity: 0;
      }
      
      @media screen and (max-width: 768px) {
        .map iframe {
          min-height: 30vh;
        }
      }
      .github {
        position: fixed;
        left: 0;
        bottom: 0;
        display: flex;
        width: 100px;
        height: 100px;
      }
      .github::before {
        content: "";
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 100px 0 0 100px;
        border-color: transparent transparent transparent #6e5494;
      }
      .github .fa {
        position: absolute;
        left: 10px;
        bottom: 5px;
        font-size: 3rem;
        color: #FFF;
      }
      
      @media screen and (max-width: 768px) {
        .github {
          width: 70px;
          height: 70px;
        }
        .github::before {
          border-width: 70px 0 0 70px;
        }
        .github .fa {
          left: 8px;
          bottom: 4px;
          font-size: 2rem;
        }
      }
      .search-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
      }
      
      </style>
      
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
      function getAllUrlParams(url) {
      
        // get query string from url (optional) or window
        var queryString = url ? url.split('?')[1] : window.location.search.slice(1);
      
        // we'll store the parameters here
        var obj = {};
      
        // if query string exists
        if (queryString) {
      
          // stuff after # is not part of query string, so get rid of it
          queryString = queryString.split('#')[0];
      
          // split our query string into its component parts
          var arr = queryString.split('&');
      
          for (var i = 0; i < arr.length; i++) {
            // separate the keys and the values
            var a = arr[i].split('=');
      
            // set parameter name and value (use 'true' if empty)
            var paramName = a[0];
            var paramValue = typeof(a[1]) === 'undefined' ? true : a[1];
            /** 
            // (optional) keep case consistent
            paramName = paramName.toLowerCase();
            if (typeof paramValue === 'string')
              paramValue = paramValue.toLowerCase();
            **/
            // if the paramName ends with square brackets, e.g. colors[] or colors[2]
            if (paramName.match(/\[(\d+)?\]$/)) {
      
              // create key if it doesn't exist
              var key = paramName.replace(/\[(\d+)?\]/, '');
              if (!obj[key])
                obj[key] = [];
      
              // if it's an indexed array e.g. colors[2]
              if (paramName.match(/\[\d+\]$/)) {
                // get the index value and add the entry at the appropriate position
                var index = /\[(\d+)\]/.exec(paramName)[1];
                obj[key][index] = paramValue;
              } else {
                // otherwise add the value to the end of the array
                obj[key].push(paramValue);
              }
            } else {
              // we're dealing with a string
              if (!obj[paramName]) {
                // if it doesn't exist, create property
                obj[paramName] = paramValue;
              } else if (obj[paramName] && typeof obj[paramName] === 'string') {
                // if property does exist and it's a string, convert it to an array
                obj[paramName] = [obj[paramName]];
                obj[paramName].push(paramValue);
              } else {
                // otherwise add the property
                obj[paramName].push(paramValue);
              }
            }
          }
        }
      
        return obj;
      };
      
      function sendPost(url, _params) {
      
        var form = document.createElement("form");
        // 設定表單的一些屬性，包含網頁接收伺服器回應的頁面或框架
        form.setAttribute("method", "post");
        form.setAttribute("action", url);
        //form.setAttribute("target", "Iframe1");
      
        // 建立隱藏的表單控制項
        for (var key in _params) {
          var hiddenField = document.createElement("input");
          hiddenField.setAttribute("type", "hidden");
          hiddenField.setAttribute("name", key);
          hiddenField.setAttribute("value", _params[key]);
          form.appendChild(hiddenField);
          //console.log(key);
        }
      
        // 隱藏的submit按鈕，預防瀏覽器不支援模糊的表單設計。（可不用）
        var hiddenSubmit = document.createElement("input");
        hiddenSubmit.setAttribute("type", "submit");
        hiddenSubmit.setAttribute("style", "display:none;");
        form.appendChild(hiddenSubmit);
      
        // 將表單加入網頁中
        document.body.appendChild(form);
      
        // 送出請求
        //form.submit();
        return new Promise(function(resolve,reject){
          fetch(`${url}`, {
            method: "POST",
            redirect: "follow", 
            // mode: "no-cors", 
            // cache: "no-cache",
            headers: {
              "Content-Type": "text/plain",
            },
            // credentials: "include",
            body: JSON.stringify(
              _params
              // {"to_add": result.map(x=> [x, prize_target])}
            )
          })
          .then(response => response.text())
          .then(context => {
            var data = JSON.parse(context);
            resolve(data);
          });
      
        })
      };
      
      function retry(maxRetries, fn) {
        return fn().catch(function(err) { 
          if (maxRetries <= 0) {
          throw err;
          }
          return retry(maxRetries - 1, fn); 
        });
      };
      
      // Builds the HTML Table out of myList.
      function buildHtmlTable(selector,myList) {
        var columns = addAllColumnHeaders(myList, selector);
      
        for (var i = 0; i < myList.length; i++) {
        var row$ = $('<tr/>');
        for (var colIndex = 0; colIndex < columns.length; colIndex++) {
          var cellValue = myList[i][columns[colIndex]];
          if (cellValue == null) cellValue = "";
          row$.append($('<td/>').html(cellValue));
        }
        $(selector).append(row$);
        }
      };
      
      // Adds a header row to the table and returns the set of columns.
      // Need to do union of keys from all records as some records may not contain
      // all records.
      function addAllColumnHeaders(myList, selector) {
        var columnSet = [];
        var headerTr$ = $('<tr/>');
      
        for (var i = 0; i < myList.length; i++) {
        var rowHash = myList[i];
        for (var key in rowHash) {
          if ($.inArray(key, columnSet) == -1) {
          columnSet.push(key);
          headerTr$.append($('<th/>').html(key));
          }
        }
        }
        $(selector).append(headerTr$);
      
        return columnSet;
      };
      
      function getToken(liffId) {
        return new Promise(function(resolve,reject){
          liff.init({
                      liffId: liffId,
                      withLoginOnExternalBrowser: true
                  }).then(function (data) {
            // if (!liff.isLoggedIn()) {
            //   window.location="https://access.line.me/oauth2/v2.1/authorize?response_type=code&client_id=2006657937&redirect_uri=https%3A%2F%2Fscript.google.com%2Fmacros%2Fs%2FAKfycbzlbEDgSYeBRV2l27H4_gn4eITQGDoJzRPlFbGCnxzO1IvmCjCUqlI0KgN4THTEHTJN%2Fexec&state=2025&scope=profile%20openid";
            // } else {
              liff.getProfile().then(function (profile) {
                var params = {};
                params['userId'] = profile.userId;
                const accessToken =  liff.getAccessToken();
                if (!accessToken) {
                  params['accessToken'] = 'Error';
                }
                params['accessToken'] = accessToken;
                //console.log(params);
                resolve(params);
              }).catch(function (error) {
                window.alert("Error getting profile: " + error);
                reject(params);
              });
            // }
          });
        });
      };
      </script>
  </head>
  <body style="overflow: hidden;background-color: unset;">
  <!-- <body style="-webkit-transform: scale(1.25);width:80%;height:80%;transform-origin: 0% 0%;overflow: hidden;"> -->
    <!-- <iframe style="display:none" name="hidden_submit" src="<?!= ScriptApp.getService().getUrl(); ?>?role=slave"></iframe> -->
    <!-- <div style="height:96vh;background-image: url('https://lh6.googleusercontent.com/z3uDSC3b3BkvXoXrHHuP56maTM6wiowO23fObGiVwtMfHOOQvoyZghLPG12cTHPFoRxsTDnPRJXNodR4EUwxLJqu6cL_fpLHuJKYDDAOuVBpQiruCBScDzOIxlCkD-3SNmbUW-vfcQ');"> -->
      <div id="loading" class="w-100 h-100 position-absolute bg-dark" style="opacity: 0.9;">
	  <div class="position-absolute top-50 start-50 translate-middle" style="text-align: center;"\>
	  <div class="spinner-border text-primary" id="spinner" role="status" style="width: 5rem;height: 5rem;">
	  <span class="sr-only"></span>
	  </div>
	  <div class="fs-1 text-white">登入中...</div>
	  </div>
	  </div>
	  <div id="bg_img" style="height:100vh;background-image: url('https://voom-obs.line-scdn.net/r/myhome/hex/cj01dWUwOGxnbHU0ZHZlJnM9anA3JnQ9ZCZ1PTFqN2NiaGpoZzNoMDAmaT0w/L1080x1920');background-size: 100% auto;background-repeat: repeat-y;">
        <div class="p-3 bd-highlight justify-content-center">         
            <div id='output'></div>
            <div class="row g-2">
            <div class="col-auto w-30">
            <select name="prize_sn" id="prize_sn" class="form-select form-select-lg mb-3" aria-label=".form-select-lg example" onclick="cancel_ready();" onchange="gen_box_options();">
                <option value="" selected disabled>請選擇獎項</option>
            </select>
            </div>
            <div class="col-auto w-40">
            <select name="box_no" id="box_no" style="display:none;" class="form-select form-select-lg mb-3" aria-label=".form-select-lg example" onclick="cancel_ready();" onchange="document.getElementById('shoot').disabled = false;document.getElementById('drawn').style.display = 'none';gen_draw_qty_options();">
              <option value="" selected disabled>請選擇箱別</option>
            </select>
            </div>
            <div class="col-auto">
              <div class="btn-group btn-group-lg" id="draw_qty" role="group" onclick="cancel_ready();" aria-label="Basic radio toggle button group">
              </div>
            </div>
	    <div class="col-auto">
                   <button id="shoot" class="btn btn-dark btn-lg" type="button" onclick="lucky_draw();" disabled>開始抽獎</button>
            </div>
            </div>
            <div id="container6" style="height:80vh;width: 100vw">
            <!-- <div id="container6" style="height:60vh;width: 100vw;"> -->
                <div id="drawing_single" style="text-align: center;text-align: -webkit-center;width: 100%;display: none;">
                    <div class="god">
                      <h1>
                        <span class="wrap no1">
                          <span>分店</span>
                        </span>
                        <span class="wrap no2">
                          <span>抽獎序號</span>
                        </span>
                        <span class="wrap no3">
                          <span>中獎人</span>
                        </span>
                      </h1>
                    </div>
                </div>
                <div class="align-items-center justify-content-center" id="drawn" style="display: none;">
                    <div style="text-align: center;width: 100%;">
                        <span id="prize_name" class="btn btn-success btn-lg"></span>
                        <br><br>
                    </div>
                    <!-- <div id="drawn_list" style="overflow: auto;height: 300px;"> -->
<!-- 		    <div id="drawn_list" style="justify-self: center;width: 75%;height: 79vh;overflow: auto;"> -->
                    <div id="drawn_list" style="justify-self: center;width: 75%;max-height: 79vh;overflow: auto;">
                    </div>
                </div>
            </div>
            <br>
<!--             <div class="d-grid gap-2">
                   <button id="shoot" class="btn btn-primary" type="button" onclick="lucky_draw();" disabled>開始抽獎</button>
            </div> -->
            
            <!-- <form target="hidden_submit" action="<?!= ScriptApp.getService().getUrl(); ?>" method="post" id="happy-lottery-form" name="happy-lottery-form" class="validate"> -->
            <!-- <form target="_self" action="<?!= ScriptApp.getService().getUrl(); ?>" method="post" id="happy-lottery-form" name="happy-lottery-form" class="validate">
            <input type="text" id="ids" name="ids" class="visually-hidden d-block"/>
            <input type="text" id="prizes" name="prizes" class="visually-hidden d-block"/>
            <input type="submit" value="開始抽獎" name="subscribe" id="subscribe" class="visually-hidden btn btn-primary w-100">
            </form> -->




        </div>
    </div>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      var is_ready = false;
      var params = new URL(document.location.toString()).searchParams;
      if (params.has("liffRedirectUri")) {
        params = new URL(decodeURIComponent(params.get("liffRedirectUri"))).searchParams;
      }
      if (!params.has("liff") || !params.has("sid")) {
        Swal.fire({
                title: '系統錯誤',
                text: "無效參數",
                icon: "error"
        });
        pause
      }

      var liffId = params.get("liff");
	  const zt = params.get('zt');
      var url = `https://script.google.com/macros/s/${params.get("sid")}/exec`;
      var text;
      var prize_result;
      var last_winner_list = "";
      if (last_winner_list) {
        last_winner_list = JSON.parse(last_winner_list);
      }
      var sleep_interval = 300;
      // 只對陣列進行局部洗牌，取前 count 個，效能極高
      function getRandomElements(arr, count) {
          if (count > arr.length) count = arr.length;
          
          // 複製陣列以避免修改到原始資料 (若不介意修改原始資料，可去掉 .slice())
          const result = arr.slice(); 
          
          for (let i = 0; i < count; i++) {
              const j = Math.floor(Math.random() * (result.length - i)) + i;
              [result[i], result[j]] = [result[j], result[i]]; // 交換
          }
          
          return result.slice(0, count);
      }

      // ---------------------------------------------------

      Array.prototype.random = function(qty) {
          return new Promise((resolve) => {
              // 優化：只取需要的數量，不洗牌整個陣列
              setTimeout(() => {
                const rr = getRandomElements(this, qty);
                resolve(rr);
              }, sleep_interval); 
          });
      }

      Array.prototype.random_table = function(qty) {
          return new Promise((resolve) => {
              if (this.length === 0) {
                  resolve([]);
                  return;
              }

              // 優化重點 1: 不需要 map 全部的桌號再洗牌
              // 直接隨機取一個索引，拿該索引的桌號作為目標
              const randomIndex = Math.floor(Math.random() * this.length);
              const target_id = this[randomIndex]["桌號"];

              // 優化重點 2: 篩選出該桌的人
              const candidates = this.filter(x => x["桌號"] === target_id);
              
              // 優化重點 3: 從候選人中隨機抽取
              const rr = getRandomElements(candidates, qty);
              
              resolve(rr);
              setTimeout(() => {
                const rr = getRandomElements(candidates, qty);
                resolve(rr);
              }, sleep_interval); 
          });
      }

      Array.prototype.random_idnumber = function(qty) {
          return new Promise((resolve) => {
              if (this.length === 0) {
                  resolve([]);
                  return;
              }

              // 優化同上：直接隨機取一個尾號
              const randomIndex = Math.floor(Math.random() * this.length);
              const target_id = this[randomIndex]["尾號"];

              const candidates = this.filter(x => x["尾號"] === target_id);
              setTimeout(() => {
                const rr = getRandomElements(candidates, qty);
                resolve(rr);
              }, sleep_interval); 
              
          });
      }

      Array.prototype.random_lottery = function(qty) {
          return new Promise((resolve) => {
              // 與 random 邏輯相同，使用高效抽取
              
              setTimeout(() => {
                const rr = getRandomElements(this, qty);
                resolve(rr);
              }, sleep_interval); 
          });
      }
      
      var slave_mode = false;
      var prizes = {};
      var prizes_dict = {};
      var shop_list = {};
      var winner_list = {};
      var name_list = {};
      var lottery_buyer_list = {};
      var special_name_list = {};
      var gift_name_list = {};
      var bonus_name_list = {};
      var table_name_list = {};
      var idnumber_name_list = {};
      var entire_name_list = {};
      var lottery_winner_list = {};
      var special_winner_list = {};
      var gift_winner_list = {};
      var bonus_winner_list = {};
      var table_winner_list = {};
      var idnumber_winner_list = {};
      var entire_winner_list = {};
      var group_list = {};
      var toggle;
    
      function load_config() {
        lines = text.split("\n");
        for(i=0;i<lines.length;i++){
          if (lines[i].match(/^\[prizes|shop_list|winner_list|name_list|lottery_buyer_list|special_name_list|gift_name_list|bonus_name_list|table_name_list|idnumber_name_list|entire_name_list|lottery_winner_list|special_winner_list|entire_winner_list|group_list|lottery_winner_list|gift_winner_list|bonus_winner_list|table_winner_list|idnumber_winner_list\]$/g)) {
            target = lines[i];
            headers = null;
          } else if (lines[i] === "") {
            continue
          } else if (!headers) {
            headers = lines[i].split(",");
          } else {
            tmp = Object.assign( ...lines[i].split(",").map((v, i) => ({[headers[i]]: v})));
            switch (target) {
              case '[prizes]':
                prizes[tmp["獎項編號"]]=tmp;
                if (prizes_dict[tmp["獎項"]]) {
                  prizes_dict[tmp["獎項"]][tmp["獎項編號"]]=tmp;
                } else {
                  prizes_dict[tmp["獎項"]] = {};
                  prizes_dict[tmp["獎項"]][tmp["獎項編號"]]=tmp;
                }
                break
              case '[shop_list]':
                shop_list[tmp["店名"]]=tmp;
                break
              case '[winner_list]':
                winner_list[tmp["身分證號"]]=tmp;
                break
              case '[lottery_buyer_list]':
                lottery_buyer_list[tmp["抽獎序號"]]=tmp["身分證號"];
                break
              case '[special_winner_list]':
                special_winner_list[tmp["身分證號"]]=tmp;
                break
              case '[gift_winner_list]':
                gift_winner_list[tmp["身分證號"]]=tmp;
                break
              case '[bonus_winner_list]':
                bonus_winner_list[tmp["身分證號"]]=tmp;
                break
              case '[table_winner_list]':
                table_winner_list[tmp["身分證號"]]=tmp;
                break
              case '[idnumber_winner_list]':
                idnumber_winner_list[tmp["身分證號"]]=tmp;
                break
              case '[name_list]':
                if (tmp["抽獎資格"]==="有") {
                  name_list[tmp["身分證號"]]=tmp;
                }
                if (tmp["特別獎"]==="是") {
                  special_name_list[tmp["身分證號"]]=tmp;
                }
                if (tmp["抽獎資格"]==="有"||tmp["抽獎資格"]==="普獎") {
                  gift_name_list[tmp["身分證號"]]=tmp;
                }
                if (tmp["抽獎資格"]==="有") {
                  bonus_name_list[tmp["身分證號"]]=tmp;
                }
                if (tmp["桌號"]!=="") {
                  table_name_list[tmp["身分證號"]]=tmp;
                }
                if (tmp["抽獎資格"]==="有") {
                  idnumber_name_list[tmp["身分證號"]]=tmp;
                }
                entire_name_list[tmp["身分證號"]] = tmp;
                break
              // case '[special_name_list]':
              //   special_name_list[tmp["身分證號"]]=tmp;
              //   break
              // case '[gift_name_list]':
              //   gift_name_list[tmp["身分證號"]]=tmp;
              //   break
              // case '[bonus_name_list]':
              //   bonus_name_list[tmp["身分證號"]]=tmp;
              //   break
              // case '[table_name_list]':
              //   table_name_list[tmp["身分證號"]]=tmp;
              //   break
              // case '[idnumber_name_list]':
              //   idnumber_name_list[tmp["身分證號"]]=tmp;
              //   break
              // case '[entire_name_list]':
              //   entire_name_list[tmp["身分證號"]]=tmp;
              //   break
              case '[lottery_winner_list]':
                lottery_winner_list[tmp["抽獎序號"]]=tmp;
                break
              case '[entire_winner_list]':
                entire_winner_list[tmp["身分證號"]]=tmp;
                break
              case '[group_list]':
                group_list[tmp["桶別"]]=tmp["區"];
                break

              // case '[last_winner_list]':
              //   last_winner_list[tmp["身分證號"]]=tmp;
              //   break
              default:
                console.log(`Error`);
            }
          }
        }
        gen_prizes_options();
        if (last_winner_list) {
            //中獎名單
            prize_target = Object.values(last_winner_list)[0]['獎項編號'];
            document.getElementById("drawn").style.display = "inline";
            var span = document.getElementById("prize_name");
            span.innerText = span.textContent = prizes[prize_target]["獎項"].replace(/(\d)(?=(\d{3})+$)/g, '$1,') + '-中獎名單';
            var drawn_list = document.getElementById("drawn_list");
            drawn_list.innerHTML = gen_list(Object.keys(last_winner_list), false);
            last_winner_list = {};
        }
        toggle = [Object.values(shop_list).map(x=>x["桶別"]), Object.values(shop_list).map(x=>x["店名"]), Object.values(name_list).map(x=>x["姓名"])];
      }
      
      function remove_prizes_options() {
        document.querySelectorAll('#prize_sn option').forEach(option => option.remove());
        var select = document.getElementById("prize_sn");
        var _option = document.createElement("option");
        _option.value = "";
        _option.innerHTML = "請選擇獎項";
        _option.selected = true;
        _option.disabled = true;
        select.appendChild(_option);
      }

      function remove_box_options() {
        document.querySelectorAll('#box_no option').forEach(option => option.remove());
        var select = document.getElementById("box_no");
        var _option = document.createElement("option");
        _option.value = "";
        _option.innerHTML = "請選擇箱別";
        _option.selected = true;
        _option.disabled = true;
        select.appendChild(_option);
        select.style.display = 'none';
      }

      function remove_draw_qty_options() {
        document.getElementById("draw_qty").innerHTML="";
      }

      function gen_prizes_options() {
        remove_prizes_options();
        remove_box_options();
        remove_draw_qty_options();
        var select = document.getElementById("prize_sn");
        var tmp;
        Object.keys(prizes_dict).forEach(_prize => {
          tmp = prizes_dict[_prize];
          quota = Object.values(tmp).map(x=>parseInt(x["名額"])).reduce((a, b) => a + b, 0);
          used = Object.values(tmp).map(x=>parseInt(x["已抽獎數"])).reduce((a, b) => a + b, 0);
          var option = document.createElement("option");
          option.value = _prize;
          if (quota > used) {
            option.innerHTML = `${_prize.replace(/(\d)(?=(\d{3})+$)/g, '$1,')} (名額:${quota}，已抽:${used})`;
          } else {
            option.innerHTML = `${_prize.replace(/(\d)(?=(\d{3})+$)/g, '$1,')} (名額:${quota}，完成抽獎)`;
            option.disabled = true;
          }
          
          select.appendChild(option);
          document.getElementById("shoot").disabled=true;
        });
        document.getElementById('prize_sn').disabled = false;
      }

      function gen_box_options() {
        remove_box_options();
        remove_draw_qty_options();
        var prize = document.getElementById("prize_sn").value;
        var select = document.getElementById("box_no");
        Object.values(prizes_dict[prize]).forEach(box => {
          quota = parseInt(box["名額"]);
          used = parseInt( box["已抽獎數"]);
          var option = document.createElement("option");
          option.value = box["獎項編號"];
          // option.setAttribute("quota", quota);
          // option.setAttribute("prize_target", box["獎項編號"]);
          // option.setAttribute("draw_all", false);
          // option.setAttribute("draw_limit", box["桶別"]);
          if (group_list[box["桶別"]]) {
            var _group = `${group_list[box["桶別"]]}，`;
          } else {
            var _group = "";
          }
          
          if (quota > used) {
            option.innerHTML = `${box["桶別"]} (${_group}名額:${quota}，已抽:${used})`;
          } else {
            option.innerHTML = `${box["桶別"]} (${_group}名額:${quota}，完成抽獎)`;
            option.disabled = true;
          }
          select.appendChild(option);
          document.getElementById("shoot").disabled=true;
        });
        if (Object.values(prizes_dict[prize]).length===1) {
          select.value = Object.values(prizes_dict[prize])[0]["獎項編號"];
          document.getElementById('shoot').disabled = false;
          document.getElementById('drawn').style.display = 'none';
          gen_draw_qty_options();
        } else {
          select.style.display = 'inline';
        }
      }

      function gen_draw_qty_options() {
        var temp = '<input type="radio" class="btn-check" name="qty" id="draw_all" autocomplete="off" value="999" checked>' +
        '<label class="btn btn-light btn-outline-dark" for="draw_all">全抽</label>';
        const prize_target = document.getElementById("box_no").selectedOptions[0].value;
        const quota = parseInt(prizes[prize_target]["名額"]);
        const draw_limit = parseInt(prizes[prize_target]["已抽獎數"]);
        const avaible_qty = quota - draw_limit;
        var target_qty = [...Array.from(Array(21).keys()).slice(1).map(x=> 5*x), 4, 3, 2, 1];
        target_qty.sort(function(a, b) {
          return b - a;
        });
        target_qty.filter(x=> x<avaible_qty && x<=10).forEach(qty => {
          temp += `<input type="radio" class="btn-check" name="qty" id="draw_${qty}" autocomplete="off" value="${qty}">` +
          `<label class="btn btn-light btn-outline-dark" for="draw_${qty}">${qty}</label>`;
        });
        document.getElementById("draw_qty").innerHTML = temp;
      }

      function gen_list(result, _type) {
        var html = '<table class="table panel-body" style="place-self: center;">' +
        '<thead>' +
        '<tr>' +
        '<th scope="col">No.</th>' +
        '<th scope="col">區別</th>' +
        '<th scope="col">店名</th>' +
        '<th scope="col">中獎姓名</th>' +
        `<th scope="col">身分證${_type==="lottery"?"(序號)":""}</th>` +
        '</tr>' +
        '</thead>' +
        '<tbody>';
	
        for(i=0;i<result.length;i++){
	  if (_type==="lottery") {
	    html += '<tr>' +
            `<th scope="row">${i+1}</th>` +
            `<td>${entire_name_list[lottery_buyer_list[result[i]]]['區']}</td>` +
            `<td>${entire_name_list[lottery_buyer_list[result[i]]]['店名']}</td>` +
            `<td>${entire_name_list[lottery_buyer_list[result[i]]]['姓名']}</td>` +
            `<td>${entire_name_list[lottery_buyer_list[result[i]]]['身分證號'].slice(0,3)}XXX${entire_name_list[lottery_buyer_list[result[i]]]['身分證號'].slice(6,10)}${"("+result[i]+")"}</td>` +
            '</tr>' +
            '<tr>';
	  } else if (_type==="special") {
	    html += '<tr>' +
            `<th scope="row">${i+1}</th>` +
            `<td>${entire_name_list[result[i]]['區']}</td>` +
            `<td>${entire_name_list[result[i]]['店名']}</td>` +
            `<td>${entire_name_list[result[i]]['姓名']}</td>` +
            `<td>${entire_name_list[result[i]]['身分證號'].slice(0,3)}XXX${special_name_list[result[i]]['身分證號'].slice(6,10)}</td>` +
            '</tr>' +
            '<tr>';
	  } else if (_type==="entire") {
	    html += '<tr>' +
            `<th scope="row">${i+1}</th>` +
            `<td>${entire_name_list[result[i]]['區']}</td>` +
            `<td>${entire_name_list[result[i]]['店名']}</td>` +
            `<td>${entire_name_list[result[i]]['姓名']}</td>` +
            `<td>${entire_name_list[result[i]]['身分證號'].slice(0,3)}XXX${entire_name_list[result[i]]['身分證號'].slice(6,10)}</td>` +
            '</tr>' +
            '<tr>';
	  } else {
	    html += '<tr>' +
            `<th scope="row">${i+1}</th>` +
            `<td>${entire_name_list[result[i]]['區']}</td>` +
            `<td>${entire_name_list[result[i]]['店名']}</td>` +
            `<td>${entire_name_list[result[i]]['姓名']}</td>` +
            `<td>${entire_name_list[result[i]]['身分證號'].slice(0,3)}XXX${name_list[result[i]]['身分證號'].slice(6,10)}</td>` +
            '</tr>' +
            '<tr>';
	  }

        }
        html += '</tbody>' +
        '</table>';
        return html
      }

      function onSuccess(result) {
        const draw_type_dict = {
          'A':'prize',
          'L':'lottery',
          'S':'special',
          'P':'gift',
          'B':'bonus',
          'T':'table',
          'I':'idnumber'
        };
        const prize_target = document.getElementById("box_no").selectedOptions[0].value;
        getToken(liffId).then(function(params){
          fetch(url, {
            method: "POST",
            redirect: "follow", 
            // mode: "cors", 
            //cache: "no-cache",
            headers: {
            "Content-Type": "text/plain",
            },
            // credentials: "include",
            body: JSON.stringify(
            {"to_add": result.map(x=> [x, prize_target]),...params}
            )
          })
          .then(response => response.text())
          .then(context => {
            //抽獎中
            console.log(context);
            document.getElementById("drawing_single").style.display = "none";
            var chk = JSON.parse(context)["to_add"];
            if (chk === "Failed") {
            Swal.fire({
              title: "系統錯誤",
              text: "請重新操作",
              icon: "error",
              showConfirmButton: false,
              timer: 1500
            });
            gen_prizes_options();
            } else {
              text = chk;
              load_config();
              gen_prizes_options();
              //中獎名單
              document.getElementById("drawn").style.display = "inline";
              var span = document.getElementById("prize_name");
              if (["S", "P", "L", "B"].includes(prizes[prize_target]["獎項編號"][0])) {
                span.innerText = span.textContent = `${prizes[prize_target]["獎項"].replace(/(\d)(?=(\d{3})+$)/g, '$1,')}-中獎名單`;
              } else if (["T"].includes(prizes[prize_target]["獎項編號"][0])) {
                span.innerText = span.textContent = `${prizes[prize_target]["獎項"].replace(/(\d)(?=(\d{3})+$)/g, '$1,')}(${prizes[prize_target]["桶別"]}:${entire_name_list[result[0]]["桌號"]})-中獎名單`;
              } else if (["I"].includes(prizes[prize_target]["獎項編號"][0])) {
                span.innerText = span.textContent = `${prizes[prize_target]["獎項"].replace(/(\d)(?=(\d{3})+$)/g, '$1,')}(${prizes[prize_target]["桶別"]}:${entire_name_list[result[0]]["尾號"]})-中獎名單`;
              } else {
                span.innerText = span.textContent = `${prizes[prize_target]["獎項"].replace(/(\d)(?=(\d{3})+$)/g, '$1,')}(${prizes[prize_target]["桶別"]}:${group_list[prizes[prize_target]["桶別"]]})-中獎名單`;
              }
              var drawn_list = document.getElementById("drawn_list");
              console.log(result);
              const _type = draw_type_dict[prizes[prize_target]["獎項編號"][0]];
              drawn_list.innerHTML = gen_list(result, _type);

            }
          })
        })
      }

      async function lucky_draw() {
        // if (typeof window.happy_lottery_tab === "function") {
        //   window.happy_lottery_tab();
        // }
		const _chk = await login();
		if (!_chk) {
			return
		}
        document.getElementById('prize_sn').disabled = true;
        document.getElementById('shoot').disabled = true;
        //即將開獎
        var prize_sn = document.getElementById("prize_sn").value;
        if (prize_sn === "") {
          alert("請選擇獎項");
        } else {
          const prize_target = document.getElementById("box_no").selectedOptions[0].value;

          // prizes
          // 獎項編號,桶別,獎項,名額,已抽名額

          // shop_list
          // 桶別,店名

          // name_list
          // 區別,店名,姓名,身分證號

          // lottery_buyer_list
          // 抽獎序號,身分證

          // winner_list
          // 身分證號,獎項編號,領取
          const quota = parseInt(prizes[prize_target]["名額"]);
          const draw_limit = parseInt(prizes[prize_target]["已抽獎數"]);
          var _qty = parseInt(document.querySelector('input[name="qty"]:checked').value);
          //抽獎中
          const qty = Math.min(_qty, quota - draw_limit);
              
          var winner_dict = {
            'A': [name_list, Object.entries(winner_list).filter(([key, value]) => value["獎項編號"][0]==="A").map(([key, value]) => key)],
            'L': [lottery_buyer_list, Object.keys(lottery_winner_list)],
            'S': [special_name_list, Object.entries(winner_list).filter(([key, value]) => value["獎項編號"][0]==="S").map(([key, value]) => key)],
            'P': [gift_name_list, Object.entries(winner_list).filter(([key, value]) => value["獎項編號"][0]==="P").map(([key, value]) => key)],
            'B': [bonus_name_list, Object.entries(winner_list).filter(([key, value]) => value["獎項編號"][0]==="B").map(([key, value]) => key)],
            'T': [table_name_list, Object.entries(winner_list).filter(([key, value]) => value["獎項編號"][0]==="T").map(([key, value]) => key)],
            'I': [idnumber_name_list, Object.entries(winner_list).filter(([key, value]) => value["獎項編號"][0]==="I").map(([key, value]) => key)]
          }

          if (prize_target[0]==="L") {
            // const lottery_winner = Object.keys(lottery_winner_list).filter(y=> lottery_winner_list[y]["獎項編號"][0]==="L");
	          const lottery_winner = winner_dict[prize_target[0]][1];
            // const target_list = Object.keys(lottery_buyer_list).filter(x=> !lottery_winner.includes(lottery_buyer_list[x]));
            const target_list = Object.keys(winner_dict[prize_target[0]][0]).filter(x=> !lottery_winner.includes(x));
            document.getElementById("drawing_single").style.display = "flex";
            choose([target_list, ...toggle.slice(1)], ["序號","店名","中獎人"]);
            target_list.random_lottery(qty).then(x=> { onSuccess(x); });

          } else if (['S', 'P', 'B', 'T', 'I'].includes(prize_target[0])) {
            const exclude_winner = [prize_target[0] , ...prizes[prize_target]["排除中獎區"]?prizes[prize_target]["排除中獎區"].split(""):[]].flatMap(key => winner_dict[key][1] || []);
            const target_list = Object.keys(winner_dict[prize_target[0]][0]).filter(x=> !exclude_winner.includes(x));
            document.getElementById("drawing_single").style.display = "flex";
            if (prize_target[0] === "T") {
              const tables = [...new Set(Object.values(table_name_list).map(x=> x["桌號"]))];
              choose([tables, tables, tables], ["桌號","桌號","桌號"]);
              target_list.random_table(qty).then(x=> { onSuccess(x); });
            } else if (prize_target[0] === "I") {
              const all_ids = [...new Set(Object.values(idnumber_name_list).map(x=> x["尾號"]))];
              choose([all_ids, all_ids, all_ids], ["尾號","尾號","尾號"]);
              target_list.random_idnumber(qty).then(x=> { onSuccess(x); });
            } else {
              choose(toggle, ["桶別","店名","中獎人"]);
              target_list.random(qty).then(x=> { onSuccess(x); });
            }
          } else if (prize_target[0]==="A") {
            // const winner = Object.keys(winner_list).filter(y=> winner_list[y]["獎項編號"][0]!=="L");
            const winner = winner_dict[prize_target[0]][1];
            const target_list = Object.keys(winner_dict[prize_target[0]][0]).filter(x=> shop_list[winner_dict[prize_target[0]][0][x]["店名"]]["桶別"]===prizes[prize_target]["桶別"]).filter(x=> !winner.includes(x));
            document.getElementById("drawing_single").style.display = "flex";
            choose(toggle, ["桶別","店名","中獎人"]);
            target_list.random(qty).then(x=> { onSuccess(x); });
            // target_list.random(qty).then(x=> { onSuccess_formpost(x); });
            // google.script.run.withSuccessHandler(onSuccess).lucky_draw(shop, prize_target, prize_sn, quota, shop_idx, draw_limit);

          }
        }
      }

      function onSuccess_formpost(ids) {
        
        prize_result = ids;
        const prize_target = document.getElementById("box_no").selectedOptions[0].value;
        var prizes = ids.map(x=>prize_target);
        if (slave_mode) {
          window.setStringifiedStorageItem('happy_lottery_slave', JSON.stringify({"ids":ids, "prizes":prizes}));
        } else {
          document.getElementById('ids').setAttribute("value", ids.join(','));
          document.getElementById('prizes').setAttribute("value", prizes.join(','));
          document.getElementById('subscribe').click();
        }
      }

      function choose(toggle, txt) {
        // 清空、插入選項
        for(let i = 0; i < toggle.length; i++) {
          var input = document.querySelector(`.wrap.no${i+1}`);
          input.innerHTML = '';
          for(let j = 0; j < toggle[i].length; j++) {
            input.insertAdjacentHTML('beforeend', '<span>' + toggle[i][j] + '</span>'); 
          }
        }

        // 加入動畫 class name
        const list1 = document.querySelectorAll('.wrap.no1> span');
        const list2 = document.querySelectorAll('.wrap.no2 > span');
        const list3 = document.querySelectorAll('.wrap.no3 > span');
        Array.prototype.forEach.call(list1, l => l.classList.add('span-10'));
        Array.prototype.forEach.call(list2, l => l.classList.add('span-10'));
        Array.prototype.forEach.call(list3, l => l.classList.add('span-10'));
        list1[0].innerText = txt[0];
        list2[0].innerText = txt[1];
        list3[0].innerText = txt[2];
      };

      window.messagesKey = 'happy_lottery_master';

      window.setStringifiedStorageItem = function (key, value) {
        localStorage.setItem(key, value);
      }

      window.handleNewMessage = function ({ key, newValue}) {
          if (key===window.messagesKey) {
            const prize_target = document.getElementById("box_no").selectedOptions[0].value;
            document.getElementById("drawing_single").style.display = "none";
            document.getElementById("drawn").style.display = "inline";
            if (text === "Failed") {
              Swal.fire({
                title: "系統錯誤",
                text: "請重新操作",
                icon: "error",
                showConfirmButton: false,
                timer: 1500
              });
              gen_prizes_options();
            } else {
              text = newValue;
              load_config();
              document.getElementById("drawn").style.display = "inline";
              var span = document.getElementById("prize_name");
              span.innerText = span.textContent = prizes[prize_target]["獎項"].replace(/(\d)(?=(\d{3})+$)/g, '$1,') + '-中獎名單';
              var drawn_list = document.getElementById("drawn_list");
              console.log(prize_result);
              drawn_list.innerHTML = gen_list(prize_result);
            }
          }
          // if (!slave_mode) {
          //   window.happy_lottery_tab.close();
          //   window.happy_lottery_tab = function () {
          //       setStringifiedStorageItem(window.messagesKey, "");
          //       window.addEventListener('storage', window.handleNewMessage);
          //       window.happy_lottery_tab = window.open("about:blank", "happy-lottery",'toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=yes,width=1,height=1');
          //   };
          //   console.log(newValue);
          //   window.removeEventListener('storage',window.handleNewMessage,false);
          // }
      }

      window.happy_lottery_tab = function () {
          setStringifiedStorageItem(window.messagesKey, "");
          window.addEventListener('storage', window.handleNewMessage);
          if (slave_mode) {
            window.happy_lottery_tab = window.open(`${url}?role=slave`, "happy-lottery");
          } else {
            window.happy_lottery_tab = window.open(`about:blank`, "happy-lottery",'toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=yes,width=1,height=1');
          }
      }
	
	  window.handleNewLogin = function ({ key, newValue}) {
	      if (window.zt === newValue) {
			  document.getElementById("loading").style.display = "none";
	          window.liff_auth.close();
	          window.removeEventListener('storage', window.handleNewLogin, false);

	      }
	  }

	function login() {
		return new Promise(function(resolve,reject){
		    liff.init({
	        	liffId: liffId
		    }).then(function() {
				if (!liff.isLoggedIn()) {
					document.getElementById("loading").style.display = "inline";
					var timestamp = new Date();
					window.zt = timestamp.getTime().toString();
					setStringifiedStorageItem(window.messagesKey, "");
					window.addEventListener('storage', window.handleNewLogin);
					var liff_url = `${window.location.href.split('?')[0]}?sid=${params.get("sid")}&liff=${liffId}&zt=${window.zt}`;
					window.liff_auth = window.open(liff_url, "_new", "width=480,height=639,left=0,0,top=0,status=0,");
					resolve(false);
				} else {
					resolve(true);
				}
			}).catch(function(error) {
				console.log(`liff.state init error ${error}`);
				resolve(false);
			});
		})
	}
      // window.onload = function () {
      //     load_config();
      // };

    function cancel_ready() {
      is_ready = false;
      document.getElementById("shoot").classList.remove("text-danger");
    }

    function changeImage(_name, src) {
      const imageElement = document.getElementById(_name);
      if (_name === "bg_img") {
        imageElement.style.backgroundImage = `url('${src}')`;
      } else if (imageElement) {
        imageElement.src = src;
      } else if (_name === "body") {
        const body = document.body;
        body.style.backgroundImage = `url('${src}')`;
      }
    }

    window.onload = async function (e) {
        // load_config();
		if (zt) {
		    liff.init({
		        liffId: liffId
		    }).then(function() {
		        if (!liff.isLoggedIn()) {
					console.log(window.location.href);
		            liff.login({ redirectUri: window.location.href });
		        } else {
		            setStringifiedStorageItem(window.messagesKey, zt);
					return
		        }
		    })
		} else {
	        getToken(liffId).then(function(params){
	            sendPost(`${url}?role=login`, params).then(function(response){
	                if (typeof response.msg !== "undefined") {
	                    Swal.fire({
	                            title: '系統錯誤',
	                            text: "請重新整理",
	                            icon: "error",
	                            timer: 5000
	                    }).then(function(){
	                        window.location = `https://liff.line.me/${liffId}`;
	                    })
	                } else {
	                  if (response.result==="NoPermission") {
					  Swal.fire({
						  title: "權限錯誤",
						  text: "您無存取權限，請聯繫管理員開通或登入其他帳號",
	                      icon: "error",
						  showDenyButton: true,
						  showCancelButton: true,
						  cancelButtonText: "關閉",
						  confirmButtonText: "重新整理",
						  denyButtonText: `登入其他帳號`
						}).then((result) => {
						  /* Read more about isConfirmed, isDenied below */
						  if (result.isConfirmed) {
							window.location = `https://liff.line.me/${liffId}`;
						  } else if (result.isDenied) {
							liff.logout();
							window.location = `https://liff.line.me/${liffId}`;
						  }
						});
	                  } else if (response.result==="OK") {
	                    changeImage("bg_img", response.lottery_sys_img);
	                    text = response.config;
	                    load_config();
						document.getElementById("loading").style.display = "none";
	                  }
	                  
	                    
	                }
	            });
	        }).catch(function (error) {
	          Swal.fire({
	                  title: '系統錯誤',
	                  text: "請重新整理",
	                  icon: "error",
	                  timer: 5000
	          }).then(function(){
	              window.location = url;
	          })
			});
		}

      document.addEventListener('keydown', function(event){
          console.log(event.button);
          if (event.key==="s") {
            if (document.getElementById("box_no").value!==''){
              is_ready = true;
              document.getElementById("shoot").classList.add("text-danger");
            }
          } else if (event.key==="e") {
            cancel_ready();
          }
      } );

      document.addEventListener('click', function(event){
        if (event.button===0 && is_ready && document.getElementById("box_no").value!=='') {
          cancel_ready();
          lucky_draw();
        }
      });
    };

    </script>
  </body>
</html>
